{{/* Excalidraw Shortcode - Boundary Lock & High Contrast */}}
{{ $src := .Get "src" }}
{{ $w := .Get "width" | default "100%" }}
{{ $h := .Get "height" | default "500px" }}
{{ $seed := now.UnixNano | md5 }}
{{ $id := printf "excalidraw-%s" $seed }}

<div class="excalidraw-wrapper relative group border-4 border-indigo-500 dark:border-indigo-400 rounded-xl bg-gray-200 dark:bg-gray-800 my-8 shadow-lg"
     style="contain: paint; isolation: isolate; width: 100%; overflow: hidden;">
  
  <div id="{{ $id }}" 
       data-url="{{ $src | relURL }}"
       style="width: 100%; height: {{ $h }};" 
       class="relative z-0">
    
    <div id="loader-{{ $id }}" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-200 dark:bg-gray-800 z-20 transition-opacity duration-300">
      <div class="h-10 w-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-3"></div>
      <span class="text-sm font-semibold text-gray-600 dark:text-gray-300">Carregando Diagrama...</span>
    </div>

  </div>

  <div id="controls-{{ $id }}" class="absolute top-4 right-4 z-50 flex gap-2 bg-white dark:bg-gray-700 p-2 rounded-lg shadow-xl border border-gray-300 dark:border-gray-600 opacity-0 pointer-events-none transition-opacity duration-300">
    <button onclick="safeZoom('{{ $id }}', 'in')" class="p-2 hover:bg-indigo-50 dark:hover:bg-gray-600 rounded text-gray-700 dark:text-gray-200 cursor-pointer transition-colors" title="Zoom In" type="button">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
    </button>
    <button onclick="safeZoom('{{ $id }}', 'out')" class="p-2 hover:bg-indigo-50 dark:hover:bg-gray-600 rounded text-gray-700 dark:text-gray-200 cursor-pointer transition-colors" title="Zoom Out" type="button">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
    </button>
    <button onclick="safeZoom('{{ $id }}', 'reset')" class="p-2 hover:bg-indigo-50 dark:hover:bg-gray-600 rounded text-gray-700 dark:text-gray-200 cursor-pointer transition-colors" title="Resetar Visualização" type="button">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
    </button>
  </div>

</div>

<script>
  // Função Global Segura (Impede erros se clicar antes de carregar)
  if (typeof window.safeZoom === 'undefined') {
      window.safeZoom = function(id, action) {
        if (window.excalidrawMap && window.excalidrawMap[id]) {
          const pz = window.excalidrawMap[id];
          if (action === 'in') pz.zoomIn();
          if (action === 'out') pz.zoomOut();
          if (action === 'reset') { pz.reset(); pz.center(); pz.fit(); }
        }
      };
  }

  (function() {
    window.excalidrawMap = window.excalidrawMap || {};
    const containerId = "{{ $id }}"; 
    const container = document.getElementById(containerId);
    
    if (!container) return;

    const controls = document.getElementById("controls-" + containerId);
    const loader = document.getElementById("loader-" + containerId);
    const svgUrl = container.getAttribute("data-url");

    const processSVG = (svgText) => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(svgText, "image/svg+xml");
      const svgEl = doc.querySelector("svg");

      if (!svgEl) throw new Error("SVG inválido");

      // Limpeza de atributos que conflitam com o zoom
      svgEl.removeAttribute('width');
      svgEl.removeAttribute('height');
      
      // Estilo Base para o SVG
      Object.assign(svgEl.style, {
        position: 'absolute',
        top: '0',
        left: '0',
        width: '100%',
        height: '100%',
        cursor: 'grab',
        // Fundo branco no próprio SVG para ele não ficar transparente no fundo cinza
        backgroundColor: 'white' 
      });
      
      return svgEl;
    };

    fetch(svgUrl)
      .then(res => {
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.text();
      })
      .then(svgText => {
        try {
          const svgElement = processSVG(svgText);
          
          if(loader) loader.style.display = 'none'; // Esconde loader
          container.appendChild(svgElement);

          setTimeout(() => {
            if (typeof svgPanZoom === 'undefined') return;

            window.excalidrawMap[containerId] = svgPanZoom(svgElement, {
              zoomEnabled: true,
              controlIconsEnabled: false,
              fit: true,
              center: true,
              minZoom: 0.5, // Impede zoom out excessivo
              maxZoom: 20,
              
              // A CONFIGURAÇÃO MÁGICA:
              contain: true, // TRUE = Impede que o SVG saia da caixa
              
              viewportSelector: container, 
              dblClickZoomEnabled: false
            });

            if (controls) {
                // Mostra os controles
                controls.classList.remove('opacity-0', 'pointer-events-none');
                controls.classList.add('opacity-100');
            }

          }, 150); // Delay levemente maior para garantir renderização

        } catch (e) {
          console.error(e);
          container.innerHTML = `<div class="p-4 text-red-500 bg-white">Erro no SVG: ${e.message}</div>`;
        }
      })
      .catch(e => {
        if(loader) loader.innerHTML = '<span class="text-red-500 bg-white p-2 rounded">Erro de conexão</span>';
      });
  })();
</script>
