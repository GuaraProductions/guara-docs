{{/* Excalidraw SVG Shortcode - Fetch Injection Strategy */}}
{{ $src := .Get "src" }}
{{ $w := .Get "width" | default "100%" }}
{{ $h := .Get "height" | default "500px" }}
{{/* ID Único */}}
{{ $seed := now.UnixNano | md5 }}
{{ $id := printf "excalidraw-%s" $seed }}

<div class="excalidraw-wrapper relative group border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden bg-gray-50 dark:bg-gray-900 transition-colors my-8">
  
  <div class="absolute top-2 right-2 z-10 flex gap-1 bg-white dark:bg-gray-800 p-1 rounded-md shadow-sm border border-gray-200 dark:border-gray-700 opacity-0 group-hover:opacity-100 transition-opacity">
    <button onclick="window.excalidrawMap['{{ $id }}'].zoomIn()" class="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300 cursor-pointer" title="Zoom In">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
    </button>
    <button onclick="window.excalidrawMap['{{ $id }}'].zoomOut()" class="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300 cursor-pointer" title="Zoom Out">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
    </button>
    <button onclick="window.excalidrawMap['{{ $id }}'].reset()" class="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300 cursor-pointer" title="Resetar">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
    </button>
  </div>

  <div id="{{ $id }}" style="width: {{ $w }}; height: {{ $h }};" class="flex items-center justify-center cursor-grab active:cursor-grabbing bg-white">
    <div class="animate-pulse flex space-x-4">
      <div class="h-4 w-32 bg-slate-200 rounded"></div>
    </div>
  </div>

</div>

<script>
  (function() {
    window.excalidrawMap = window.excalidrawMap || {};
    const container = document.getElementById('{{ $id }}');
    const svgUrl = '{{ $src | relURL }}';

    // Função de Inicialização
    const initZoom = (svgElement) => {
      // Configura o SVG para ocupar 100% do container
      svgElement.style.width = "100%";
      svgElement.style.height = "100%";
      
      if (typeof svgPanZoom === 'undefined') {
        console.error('[Excalidraw] Biblioteca svg-pan-zoom não encontrada.');
        return;
      }

      window.excalidrawMap['{{ $id }}'] = svgPanZoom(svgElement, {
        zoomEnabled: true,
        controlIconsEnabled: false,
        fit: true,
        center: true,
        minZoom: 0.1,
        maxZoom: 10,
        dblClickZoomEnabled: false,
      });
    };

    // 1. Busca o arquivo SVG via Fetch
    fetch(svgUrl)
      .then(response => {
        if (!response.ok) throw new Error('Erro ao carregar SVG: ' + response.statusText);
        return response.text();
      })
      .then(svgContent => {
        // 2. Injeta o código SVG diretamente na DIV
        container.innerHTML = svgContent;
        
        // 3. Encontra o elemento <svg> recém-criado
        const svgElement = container.querySelector('svg');
        
        if (svgElement) {
          initZoom(svgElement);
        } else {
          console.error('[Excalidraw] O arquivo carregado não contém uma tag <svg> válida.');
          container.innerHTML = '<p class="text-red-500 text-sm">Erro: SVG inválido.</p>';
        }
      })
      .catch(error => {
        console.error('[Excalidraw] Falha no fetch:', error);
        container.innerHTML = `<p class="text-red-500 text-sm">Erro ao carregar diagrama.</p>`;
      });
  })();
</script>
