{{/* Excalidraw SVG Shortcode - Versão "Deep Dive" */}}
{{ $src := .Get "src" }}
{{ $w := .Get "width" | default "100%" }}
{{ $h := .Get "height" | default "500px" }}

{{/* Hash MD5 para ID seguro */}}
{{ $seed := now.UnixNano | md5 }}
{{ $id := printf "excalidraw-%s" $seed }}

<div class="excalidraw-wrapper relative group border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden bg-gray-50 dark:bg-gray-900 transition-colors my-8">
  
  <div class="absolute top-2 right-2 z-10 flex gap-1 bg-white dark:bg-gray-800 p-1 rounded-md shadow-sm border border-gray-200 dark:border-gray-700 opacity-0 group-hover:opacity-100 transition-opacity">
    <button onclick="window.excalidrawMap['{{ $id }}'].zoomIn()" class="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300 cursor-pointer" aria-label="Zoom In" title="Zoom In">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
    </button>
    <button onclick="window.excalidrawMap['{{ $id }}'].zoomOut()" class="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300 cursor-pointer" aria-label="Zoom Out" title="Zoom Out">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
    </button>
    <button onclick="window.excalidrawMap['{{ $id }}'].reset()" class="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300 cursor-pointer" aria-label="Reset Zoom" title="Resetar">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
    </button>
  </div>

  <div style="width: {{ $w }}; height: {{ $h }};" class="cursor-grab active:cursor-grabbing bg-white">
    <object 
      id="{{ $id }}" 
      type="image/svg+xml" 
      data="{{ $src | relURL }}" 
      style="width: 100%; height: 100%; display: block;">
      <img src="{{ $src | relURL }}" alt="Diagrama Excalidraw" />
    </object>
  </div>

</div>

<script>
  (function() {
    // Garante que o mapa global existe
    window.excalidrawMap = window.excalidrawMap || {};
    
    const obj = document.getElementById('{{ $id }}');
    
    const init = () => {
      // 1. Verificação de Segurança: Biblioteca carregada?
      if (typeof svgPanZoom === 'undefined') {
        console.error('[Excalidraw] svg-pan-zoom não encontrado. Adicione o script no baseof.html');
        return;
      }

      try {
        // 2. O PULO DO GATO: Pegar o SVG *dentro* do Object
        const internalSvg = obj.contentDocument.documentElement;
        
        // Se não for um SVG (ex: erro 404 retornando HTML), aborta
        if (internalSvg.tagName.toLowerCase() !== 'svg') {
          console.warn('[Excalidraw] Conteúdo não é um SVG válido.');
          return;
        }

        // 3. Inicializa a biblioteca DIRETAMENTE no elemento SVG interno
        window.excalidrawMap['{{ $id }}'] = svgPanZoom(internalSvg, {
          zoomEnabled: true,
          controlIconsEnabled: false,
          fit: true,
          center: true,
          minZoom: 0.1,
          maxZoom: 10,
          dblClickZoomEnabled: false, // Evita zoom acidental
          // Corrige o comportamento do Pan para ser suave
          beforePan: function(oldPan, newPan){ 
            return {x: newPan.x, y: newPan.y}; 
          }
        });
        
        console.log('[Excalidraw] Zoom iniciado com sucesso para:', '{{ $id }}');

      } catch (e) {
        console.error('[Excalidraw] Erro ao inicializar zoom. Possível bloqueio de CORS ou SVG inválido.', e);
      }
    };

    // Tenta iniciar apenas quando o objeto estiver totalmente carregado
    if (obj.contentDocument && obj.contentDocument.readyState === 'complete') {
        init();
    } else {
        obj.addEventListener('load', init);
    }
  })();
</script>
