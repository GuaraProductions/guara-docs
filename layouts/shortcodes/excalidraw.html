{{/* Excalidraw Shortcode - Versão DOMParser Robusta */}}
{{ $src := .Get "src" }}
{{ $w := .Get "width" | default "100%" }}
{{ $h := .Get "height" | default "500px" }}
{{ $seed := now.UnixNano | md5 }}
{{ $id := printf "excalidraw-%s" $seed }}

<div class="excalidraw-wrapper relative group border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden bg-gray-50 dark:bg-gray-900 transition-colors my-8">
  
  <div id="controls-{{ $id }}" class="absolute top-2 right-2 z-10 flex gap-1 bg-white dark:bg-gray-800 p-1 rounded-md shadow-sm border border-gray-200 dark:border-gray-700 opacity-0 pointer-events-none transition-opacity duration-300">
    <button onclick="safeZoom('{{ $id }}', 'in')" class="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300 cursor-pointer" title="Zoom In">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
    </button>
    <button onclick="safeZoom('{{ $id }}', 'out')" class="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300 cursor-pointer" title="Zoom Out">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
    </button>
    <button onclick="safeZoom('{{ $id }}', 'reset')" class="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300 cursor-pointer" title="Resetar">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
    </button>
  </div>

  <div id="{{ $id }}" style="width: {{ $w }}; height: {{ $h }};" class="flex items-center justify-center bg-white overflow-hidden relative">
    <div id="loader-{{ $id }}" class="animate-pulse flex flex-col items-center">
      <div class="h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-2"></div>
      <span class="text-sm text-gray-500">Carregando diagrama...</span>
    </div>
  </div>

</div>

<script>
  // Função global segura para os botões (evita erro "undefined")
  function safeZoom(id, action) {
    if (window.excalidrawMap && window.excalidrawMap[id]) {
      if (action === 'in') window.excalidrawMap[id].zoomIn();
      if (action === 'out') window.excalidrawMap[id].zoomOut();
      if (action === 'reset') window.excalidrawMap[id].reset();
    } else {
      console.warn('Diagrama ainda não pronto ou falhou ao carregar.');
    }
  }

  (function() {
    window.excalidrawMap = window.excalidrawMap || {};
    const container = document.getElementById('{{ $id }}');
    const controls = document.getElementById('controls-{{ $id }}');
    const loader = document.getElementById('loader-{{ $id }}');
    const svgUrl = '{{ $src | relURL }}';

    // Função de tratamento do SVG
    const processSVG = (svgText) => {
      // 1. Parseia a string para um documento XML real
      const parser = new DOMParser();
      const doc = parser.parseFromString(svgText, "image/svg+xml");
      const svgEl = doc.querySelector("svg");

      if (!svgEl) {
        throw new Error("Não foi encontrado elemento <svg> no arquivo.");
      }

      // 2. Remove atributos fixos que travam o zoom (Crucial para Excalidraw!)
      svgEl.removeAttribute('width');
      svgEl.removeAttribute('height');
      // Garante que ocupe 100%
      svgEl.style.width = "100%";
      svgEl.style.height = "100%";
      svgEl.style.maxWidth = "none"; // Previne regras de CSS globais
      
      // 3. Adiciona um ID único ao elemento SVG para a biblioteca achar
      svgEl.id = "svg-internal-{{ $id }}";

      return svgEl;
    };

    fetch(svgUrl)
      .then(response => {
        if (!response.ok) throw new Error('Status: ' + response.status);
        return response.text();
      })
      .then(svgText => {
        try {
          // Processa o SVG
          const svgElement = processSVG(svgText);

          // Limpa o loader e insere o SVG
          loader.remove();
          container.appendChild(svgElement);

          // Pequeno delay para garantir que o navegador renderizou o DOM
          setTimeout(() => {
            if (typeof svgPanZoom === 'undefined') {
              console.error('Biblioteca svg-pan-zoom não encontrada.');
              return;
            }

            // INICIALIZAÇÃO
            window.excalidrawMap['{{ $id }}'] = svgPanZoom(svgElement, {
              zoomEnabled: true,
              controlIconsEnabled: false,
              fit: true,
              center: true,
              minZoom: 0.1,
              maxZoom: 10,
              viewportSelector: document.getElementById('{{ $id }}'), // Restringe eventos ao container
              dblClickZoomEnabled: false
            });

            // Ativa os controles visuais (opacidade 1 e permite cliques)
            controls.classList.remove('opacity-0', 'pointer-events-none');
            controls.classList.add('opacity-100', 'group-hover:opacity-100'); // Força visibilidade
            
            console.log('Excalidraw carregado com sucesso:', '{{ $id }}');

          }, 100); // 100ms de respiro para o motor de renderização

        } catch (parseError) {
          console.error('Erro ao processar SVG:', parseError);
          container.innerHTML = `<p class="text-red-500 p-4">Erro no formato do arquivo.</p>`;
        }
      })
      .catch(err => {
        console.error('Erro no fetch:', err);
        loader.innerHTML = '<span class="text-red-500">Erro ao baixar arquivo.</span>';
      });
  })();
</script>
